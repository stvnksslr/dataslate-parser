name: Rollback Release

on:
  push:
    tags:
      - "*.*"

# steps to roll back a release via flux cli
# 1. flux suspend image repository dataslate-repo
# 2. flux create image policy dataslate-policy --image-ref=dataslate-repo --select-semver=1.7.4

# step to resume automation
# 1. flux resume image repository dataslate-repo

jobs:
  fluxctl:
    runs-on: ubuntu-latest
    environment:
      name: prod
    steps:
      - name: "Setup Kubectl"
        uses: azure/setup-kubectl@v2.0
      - name: "Set Context"
        uses: azure/k8s-set-context@v2
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}
      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
        with:
          fallback: 1.0.0 # Optional fallback tag to use when no tag can be found
      - name: "Install Flux"
        run: curl -s https://fluxcd.io/install.sh | sudo bash
      - name: "Suspend Dataslate Deployments"
        run: flux suspend image repository dataslate-repo
      - name: "Roll back deployment"
        run: flux create image policy dataslate-policy --image-ref=dataslate-repo --select-semver= ${{ previoustag }}
        continue-on-error: true



    
