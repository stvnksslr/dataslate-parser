name: Rollback Release

on:
  push:
    tags:
      - "*.*"

# steps to roll back a release via flux cli
# 1. flux suspend image repository dataslate-repo
# 2. flux create image policy dataslate-policy --image-ref=dataslate-repo --select-semver=1.7.4

# step to resume automation
# 1. flux resume image repository dataslate-repo

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment:
      name: prod
    steps:
      - uses: actions/checkout@master
      
      - name: "Setup Kubectl"
        uses: azure/setup-kubectl@v2.0
      
      - name: "Set Context"
        uses: azure/k8s-set-context@v2
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}
      
      - name: Get previous release tag
        uses: SOLIDSoftworks/semver-tags@latest
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN}}
          default-version: '1.7.5'
      
      - name: "Install Flux"
        run: curl -s https://fluxcd.io/install.sh | sudo bash
      
      - name: "Suspend Dataslate Deployments"
        run: flux suspend image repository dataslate-repo
      
      - name: "Roll back deployment"
        run: flux create image policy dataslate-policy --image-ref=dataslate-repo --select-semver= ${{ previous-version }}
        continue-on-error: true



    
